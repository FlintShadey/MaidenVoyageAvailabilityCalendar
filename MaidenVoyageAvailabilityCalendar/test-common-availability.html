<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Common Availability Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
      }
      button {
        margin: 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Common Availability Functionality Test</h1>
    <p>
      This test verifies that the "Second Row: Common Availability" section is
      working correctly across different browsers.
    </p>

    <div class="test-section">
      <h2>Test 1: Basic Common Dates Computation</h2>
      <button onclick="runBasicTest()">Run Basic Test</button>
      <div id="basicTestResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>Test 2: Cross-Browser Compatibility</h2>
      <button onclick="runCrossBrowserTest()">Run Cross-Browser Test</button>
      <div id="crossBrowserResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>Test 3: Edge Cases</h2>
      <button onclick="runEdgeCaseTest()">Run Edge Case Test</button>
      <div id="edgeCaseResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>Test 4: Performance Test</h2>
      <button onclick="runPerformanceTest()">Run Performance Test</button>
      <div id="performanceResult" class="result"></div>
    </div>

    <div class="test-section">
      <h2>Browser Information</h2>
      <div id="browserInfo" class="result"></div>
    </div>

    <script>
      // Display browser information
      document.getElementById("browserInfo").innerHTML = `
            <strong>User Agent:</strong> ${navigator.userAgent}<br>
            <strong>Browser Type:</strong> ${getBrowserType()}<br>
            <strong>Platform:</strong> ${navigator.platform}<br>
            <strong>Language:</strong> ${navigator.language}
        `;

      function getBrowserType() {
        const userAgent = navigator.userAgent;
        if (userAgent.includes("Safari") && !userAgent.includes("Chrome"))
          return "Safari";
        if (userAgent.includes("Chrome")) return "Chrome";
        if (userAgent.includes("Firefox")) return "Firefox";
        if (userAgent.includes("Edge")) return "Edge";
        return "Unknown";
      }

      // Common dates computation function (copied from App.vue)
      function computeCommonDatesSafe(usersData, trigger) {
        console.log(
          "üîß computeCommonDatesSafe: Starting computation, trigger:",
          trigger
        );

        if (!usersData || usersData.length === 0) {
          console.log("üîß computeCommonDatesSafe: No users data");
          return [];
        }

        // Method 1: Try the for-loop approach (most compatible)
        try {
          console.log("üîß computeCommonDatesSafe: Trying for-loop method");

          const allSelectedDates = [];
          const seenTimestamps = new Set();

          for (const user of usersData) {
            if (!Array.isArray(user.availableDates)) continue;

            for (const date of user.availableDates) {
              if (
                date instanceof Date &&
                !isNaN(date.getTime()) &&
                date.getFullYear() >= 2020 &&
                date.getFullYear() <= 2030
              ) {
                const timestamp = date.getTime();
                if (!seenTimestamps.has(timestamp)) {
                  seenTimestamps.add(timestamp);
                  allSelectedDates.push(date);
                }
              }
            }
          }

          const commonDates = [];

          for (const date of allSelectedDates) {
            const dateTimestamp = date.getTime();
            let isCommonToAll = true;

            for (const user of usersData) {
              if (!Array.isArray(user.availableDates)) {
                isCommonToAll = false;
                break;
              }

              let userHasThisDate = false;
              for (const userDate of user.availableDates) {
                if (
                  userDate instanceof Date &&
                  !isNaN(userDate.getTime()) &&
                  userDate.getTime() === dateTimestamp
                ) {
                  userHasThisDate = true;
                  break;
                }
              }

              if (!userHasThisDate) {
                isCommonToAll = false;
                break;
              }
            }

            if (isCommonToAll) {
              commonDates.push(date);
            }
          }

          commonDates.sort((a, b) => a.getTime() - b.getTime());
          console.log(
            "‚úÖ computeCommonDatesSafe: For-loop method succeeded, found",
            commonDates.length,
            "dates"
          );
          return commonDates;
        } catch (error) {
          console.warn(
            "‚ö†Ô∏è computeCommonDatesSafe: For-loop method failed:",
            error.message
          );
          return [];
        }
      }

      function runBasicTest() {
        const testUsers = [
          {
            name: "Jessica",
            availableDates: [
              new Date("2025-05-15"),
              new Date("2025-05-20"),
              new Date("2025-06-01"),
            ],
          },
          {
            name: "Flint",
            availableDates: [
              new Date("2025-05-15"),
              new Date("2025-05-25"),
              new Date("2025-06-01"),
            ],
          },
          {
            name: "Josh & Karen",
            availableDates: [new Date("2025-05-15"), new Date("2025-06-01")],
          },
        ];

        const result = computeCommonDatesSafe(testUsers, Date.now());
        const expected = 2; // 2025-05-15 and 2025-06-01

        const resultDiv = document.getElementById("basicTestResult");
        if (result.length === expected) {
          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    ‚úÖ <strong>PASS:</strong> Found ${
                      result.length
                    } common dates as expected<br>
                    Common dates: ${result
                      .map((d) => d.toISOString().split("T")[0])
                      .join(", ")}
                `;
        } else {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    ‚ùå <strong>FAIL:</strong> Expected ${expected} common dates, found ${
            result.length
          }<br>
                    Common dates: ${result
                      .map((d) => d.toISOString().split("T")[0])
                      .join(", ")}
                `;
        }
      }

      function runCrossBrowserTest() {
        const browserType = getBrowserType();
        const testUsers = [
          { name: "User1", availableDates: [new Date("2025-05-15")] },
          { name: "User2", availableDates: [new Date("2025-05-15")] },
          { name: "User3", availableDates: [new Date("2025-05-15")] },
          { name: "User4", availableDates: [new Date("2025-05-15")] },
        ];

        const start = performance.now();
        const result = computeCommonDatesSafe(testUsers, Date.now());
        const end = performance.now();

        const resultDiv = document.getElementById("crossBrowserResult");
        if (result.length === 1) {
          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    ‚úÖ <strong>PASS:</strong> Cross-browser test successful on ${browserType}<br>
                    Execution time: ${(end - start).toFixed(2)}ms<br>
                    Common dates: ${result
                      .map((d) => d.toISOString().split("T")[0])
                      .join(", ")}
                `;
        } else {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    ‚ùå <strong>FAIL:</strong> Cross-browser test failed on ${browserType}<br>
                    Expected 1 common date, found ${result.length}
                `;
        }
      }

      function runEdgeCaseTest() {
        const tests = [
          { name: "Empty users", users: [], expected: 0 },
          {
            name: "Users with no dates",
            users: [{ name: "User1", availableDates: [] }],
            expected: 0,
          },
          {
            name: "Single user",
            users: [
              { name: "User1", availableDates: [new Date("2025-05-15")] },
            ],
            expected: 1,
          },
          {
            name: "Invalid dates",
            users: [
              {
                name: "User1",
                availableDates: [new Date("invalid"), new Date("2025-05-15")],
              },
              { name: "User2", availableDates: [new Date("2025-05-15")] },
            ],
            expected: 1,
          },
        ];

        let passedTests = 0;
        let failedTests = 0;
        let results = [];

        tests.forEach((test) => {
          const result = computeCommonDatesSafe(test.users, Date.now());
          if (result.length === test.expected) {
            passedTests++;
            results.push(`‚úÖ ${test.name}: PASS`);
          } else {
            failedTests++;
            results.push(
              `‚ùå ${test.name}: FAIL (expected ${test.expected}, got ${result.length})`
            );
          }
        });

        const resultDiv = document.getElementById("edgeCaseResult");
        if (failedTests === 0) {
          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    ‚úÖ <strong>ALL EDGE CASES PASSED</strong><br>
                    Passed: ${passedTests}/${tests.length}<br>
                    ${results.join("<br>")}
                `;
        } else {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    ‚ùå <strong>SOME EDGE CASES FAILED</strong><br>
                    Passed: ${passedTests}/${tests.length}<br>
                    ${results.join("<br>")}
                `;
        }
      }

      function runPerformanceTest() {
        // Create a large dataset to test performance
        const largeUsers = [];
        for (let i = 0; i < 100; i++) {
          const dates = [];
          for (let j = 0; j < 50; j++) {
            const date = new Date("2025-05-01");
            date.setDate(date.getDate() + j);
            dates.push(date);
          }
          largeUsers.push({ name: `User${i}`, availableDates: dates });
        }

        const start = performance.now();
        const result = computeCommonDatesSafe(largeUsers, Date.now());
        const end = performance.now();

        const executionTime = end - start;
        const resultDiv = document.getElementById("performanceResult");

        if (executionTime < 1000) {
          // Less than 1 second
          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    ‚úÖ <strong>PERFORMANCE TEST PASSED</strong><br>
                    Processed 100 users with 50 dates each<br>
                    Execution time: ${executionTime.toFixed(2)}ms<br>
                    Common dates found: ${result.length}
                `;
        } else {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    ‚ö†Ô∏è <strong>PERFORMANCE WARNING</strong><br>
                    Execution time: ${executionTime.toFixed(2)}ms (>1000ms)<br>
                    Common dates found: ${result.length}
                `;
        }
      }

      // Auto-run basic test on page load
      window.onload = function () {
        runBasicTest();
      };
    </script>
  </body>
</html>
